<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Book</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'CiscoSans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #333;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #049fd9;
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h2 {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }
        
        .search-container {
            padding: 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        
        .search-box {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 36px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            border-color: #049fd9;
            box-shadow: 0 0 0 2px rgba(4, 159, 217, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            display: none;
        }
        
        .clear-btn:hover {
            background: #e0e0e0;
        }
        
        .clear-btn.visible {
            display: block;
        }
        
        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .contact-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .contact-item:hover {
            background: #f8f8f8;
            border-color: #049fd9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #049fd9, #0073a8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .contact-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .contact-number {
            font-size: 13px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .contact-actions {
            display: flex;
            gap: 4px;
        }
        
        .action-btn {
            background: #049fd9;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        .action-btn:hover {
            background: #0073a8;
        }
        
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .error {
            background: #ffe0e0;
            color: #d32f2f;
            padding: 12px;
            margin: 16px;
            border-radius: 4px;
            border-left: 4px solid #d32f2f;
        }
        
        .status-bar {
            background: #f5f5f5;
            padding: 8px 16px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>üìí Contact Center Directory</h2>
    </div>
    
    <div class="search-container">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input 
                type="text" 
                class="search-input" 
                id="searchInput" 
                placeholder="Search by name or number..."
                autocomplete="off"
            >
            <button class="clear-btn" id="clearBtn">‚úï</button>
        </div>
    </div>
    
    <div class="contacts-list" id="contactsList">
        <div class="loading">Loading address book...</div>
    </div>
    
    <div class="status-bar" id="statusBar">
        Connecting to Contact Center...
    </div>

    <script>
        const ADDRESS_BOOK_ID = 'a34d966f-6908-4334-be51-4ab77a8279bf';
        let allContacts = [];
        let filteredContacts = [];
        
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');
        const contactsList = document.getElementById('contactsList');
        const statusBar = document.getElementById('statusBar');

        // Initialize Desktop SDK - try parent window first for iframe context
        async function initializeSDK() {
            try {
                // Check if SDK is available in current window
                if (window.agentx && window.agentx.desktop) {
                    statusBar.textContent = 'Connected to Agent Desktop';
                    await loadAddressBook();
                    return;
                }
                
                // Try parent window (iframe context)
                if (window.parent && window.parent.agentx && window.parent.agentx.desktop) {
                    window.agentx = window.parent.agentx;
                    statusBar.textContent = 'Connected to Agent Desktop (iframe)';
                    await loadAddressBook();
                    return;
                }
                
                // Fallback: Load SDK dynamically
                await loadSDKScript();
                if (window.agentx && window.agentx.desktop) {
                    await window.agentx.desktop.initialize();
                    statusBar.textContent = 'Connected to Agent Desktop';
                    await loadAddressBook();
                } else {
                    throw new Error('SDK not available');
                }
            } catch (error) {
                console.error('SDK initialization error:', error);
                statusBar.textContent = 'Using fallback mode...';
                await loadAddressBookFallback();
            }
        }
        
        // Load SDK script dynamically
        function loadSDKScript() {
            return new Promise((resolve, reject) => {
                if (window.agentx) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cjaas.cisco.com/agentx/desktop-js-sdk.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Load address book data
        async function loadAddressBook() {
            try {
                // Get auth token from SDK
                const config = await window.agentx.desktop.configuration.get();
                const token = config.accessToken || config.authToken;
                const orgId = config.organizationId || config.orgId;
                const baseUrl = 'https://api.wxcc-us1.cisco.com';
                
                // Fetch address book entries
                const response = await fetch(`${baseUrl}/organization/${orgId}/address-book/${ADDRESS_BOOK_ID}/entries`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                allContacts = data.data || data.entries || [];
                
                if (allContacts.length === 0) {
                    contactsList.innerHTML = '<div class="no-results">No contacts found in this address book.</div>';
                    statusBar.textContent = 'Address book is empty';
                } else {
                    filteredContacts = [...allContacts];
                    renderContacts();
                    statusBar.textContent = `${allContacts.length} contacts loaded`;
                }
            } catch (error) {
                console.error('Failed to load address book:', error);
                showError(`Failed to load contacts: ${error.message}`);
            }
        }

        // Render contacts list
        function renderContacts() {
            if (filteredContacts.length === 0) {
                contactsList.innerHTML = '<div class="no-results">No contacts match your search.</div>';
                return;
            }
            
            const html = filteredContacts.map(contact => {
                const name = contact.name || contact.firstName + ' ' + contact.lastName || 'Unknown';
                const number = contact.phoneNumber || contact.number || 'No number';
                const initials = getInitials(name);
                
                return `
                    <div class="contact-item" onclick="selectContact('${contact.id}', '${number}')">
                        <div class="contact-avatar">${initials}</div>
                        <div class="contact-info">
                            <div class="contact-name">${escapeHtml(name)}</div>
                            <div class="contact-number">${escapeHtml(number)}</div>
                        </div>
                        <div class="contact-actions">
                            <button class="action-btn" onclick="dialContact(event, '${escapeHtml(number)}')">üìû Call</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            contactsList.innerHTML = html;
        }

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            if (query) {
                clearBtn.classList.add('visible');
                filteredContacts = allContacts.filter(contact => {
                    const name = (contact.name || contact.firstName + ' ' + contact.lastName || '').toLowerCase();
                    const number = (contact.phoneNumber || contact.number || '').toLowerCase();
                    return name.includes(query) || number.includes(query);
                });
            } else {
                clearBtn.classList.remove('visible');
                filteredContacts = [...allContacts];
            }
            
            renderContacts();
            statusBar.textContent = `${filteredContacts.length} of ${allContacts.length} contacts`;
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.classList.remove('visible');
            filteredContacts = [...allContacts];
            renderContacts();
            statusBar.textContent = `${allContacts.length} contacts loaded`;
        });

        // Dial contact
        async function dialContact(event, number) {
            event.stopPropagation();
            try {
                if (window.agentx && window.agentx.desktop && window.agentx.desktop.dialer) {
                    await window.agentx.desktop.dialer.startOutdialContact(number);
                    statusBar.textContent = `Dialing ${number}...`;
                } else {
                    statusBar.textContent = `Click-to-dial not available in this mode`;
                }
            } catch (error) {
                console.error('Dial error:', error);
                statusBar.textContent = `Failed to dial: ${error.message}`;
            }
        }
        
        // Fallback method to load address book without SDK
        async function loadAddressBookFallback() {
            // Use sample data for demonstration
            allContacts = [
                { id: '1', name: 'Sample Contact 1', phoneNumber: '+1-555-0001', firstName: 'Sample', lastName: 'Contact 1' },
                { id: '2', name: 'Sample Contact 2', phoneNumber: '+1-555-0002', firstName: 'Sample', lastName: 'Contact 2' },
                { id: '3', name: 'Sample Contact 3', phoneNumber: '+1-555-0003', firstName: 'Sample', lastName: 'Contact 3' }
            ];
            filteredContacts = [...allContacts];
            renderContacts();
            statusBar.textContent = `Sample data loaded (SDK not available)`;
            showError('Could not connect to Agent Desktop SDK. Showing sample data. Please ensure this widget is loaded within Webex Contact Center Agent Desktop.');
        }

        // Select contact (for future use)
        function selectContact(id, number) {
            console.log('Contact selected:', id, number);
            statusBar.textContent = `Selected: ${number}`;
        }

        // Utility functions
        function getInitials(name) {
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            contactsList.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
            statusBar.textContent = 'Error loading address book';
        }

        // Initialize when page loads
        // Give the page a moment to load, then initialize
        setTimeout(() => {
            initializeSDK();
        }, 500);
    </script>
</body>
</html>
